#!/bin/bash
echo

# --- VÄRVID ---
RED='\033[1;31m'
YELLOW='\033[1;33m'
GREEN='\033[1;32m'
BOLD='\033[1m'
RESET='\033[0m'

# --- Quota kasutus ---
quota_output=$(quota -s 2>/dev/null)
if [ $? -ne 0 ]; then
    echo -e "${RED}Quota käsk ebaõnnestus või pole saadaval.${RESET}"
else
quota | awk 'NR>2 {
    used=$2/1024/1024
    limit=$3/1024/1024
    if (limit >= 1024) limit_tb = limit/1024
    percent = (used / limit) * 100
    if (limit >= 1024) printf "%.2f GiB (limiit: %.2f TiB, %.2f%%)\n", used, limit_tb, percent
    else printf "%.2f GiB (limiit: %.2f GiB, %.2f%%)\n", used, limit, percent
}' | while read -r line; do
    used=$(echo "$line" | awk '{print $1" "$2}')
    rest=$(echo "$line" | cut -d' ' -f3-)
    percent=$(echo "$line" | awk -F'[(),%]' '{print $3}' | awk '{printf "%d",$1}')  # tõeline protsent täisarvuna

    if (( percent >= 80 )); then color=$RED
    elif (( percent >= 50 )); then color=$YELLOW
    else color=$GREEN; fi

    echo -e "${BOLD}Kasutusel mahtu:${RESET} ${color}${used}${RESET} ${rest}"
done
fi

# --- Top 10 kaustad praeguses kaustas ---


# --- Domeenide kaustad ---
if [ -d "./domeenid" ]; then
    for dir in ./domeenid/*; do
        [ -d "$dir" ] || continue
        echo -e "\n${BOLD}$(basename "$dir") kausta jaotus (top 10):${RESET}"
        du -s "$dir"/* 2>/dev/null | sort -rn | head -n 10 | awk -v RED="$RED" -v YELLOW="$YELLOW" -v GREEN="$GREEN" -v RESET="$RESET" '
        {
            size=$1
            name=$2
            hum_size=""
            if (size >= 1048576) hum_size = sprintf("%.1f MB", size/1024/1024)
            else if (size >= 1024) hum_size = sprintf("%d KB", size/1024)
            else hum_size = size " B"

            color=GREEN
            if(size>=10485760) color=RED
            else if(size>=1048576) color=YELLOW

            printf "%s%7s%s %s\n", color, hum_size, RESET, name
        }'
    done

    echo -e "\n${BOLD}./domeenid kausta jaotus (top 10):${RESET}"
    du -s ./domeenid/* 2>/dev/null | sort -rn | head -n 10 | awk -v RED="$RED" -v YELLOW="$YELLOW" -v GREEN="$GREEN" -v RESET="$RESET" '
    {
        size=$1
        name=$2
        hum_size=""
        if (size >= 1048576) hum_size = sprintf("%.1f MB", size/1024/1024)
        else if (size >= 1024) hum_size = sprintf("%d KB", size/1024)
        else hum_size = size " B"

        color=GREEN
        if(size>=10485760) color=RED
        else if(size>=1048576) color=YELLOW

        printf "%s%7s%s %s\n", color, hum_size, RESET, name
    }'
fi

echo
