#!/bin/bash
bash <(curl -s dev.tihkel.ee/banner.id) "INODES"
echo

# --- COLORS ---
RED='\033[1;31m'
YELLOW='\033[1;33m'
GREEN='\033[1;32m'
BOLD='\033[1m'
RESET='\033[0m'

# --- KASUTUSEL INODED ---
quota_output=$(quota -s 2>/dev/null)
if [ $? -ne 0 ]; then
    echo -e "${RED}Quota käsk ebaõnnestus või pole saadaval.${RESET}"
else
    inode_info=$(echo "$quota_output" | awk 'NR==3 {print $5, $6}')
    read -r used_raw limit_raw <<< "$inode_info"
    parse_k() {
        local val="$1"
        if [[ "$val" =~ ^([0-9]+)k$ ]]; then
            echo $(( ${BASH_REMATCH[1]} * 1024 ))
        else
            echo "$val"
        fi
    }
    used=$(parse_k "$used_raw")
    limit_num=$(parse_k "$limit_raw")
    percent=$(( used * 100 / limit_num ))
    if [ "$percent" -ge 80 ]; then
        color=$RED
    elif [ "$percent" -ge 50 ]; then
        color=$YELLOW
    else
        color=$GREEN
    fi
    echo -e "${BOLD}Kasutusel inoded:${RESET} ${color}${used}${RESET} (limiit: ${limit_raw}, $percent%)"
fi

# --- PRAEGUSE KAUSTA JAOTUS ---
echo -e "\n${BOLD}Praeguse kausta jaotus (top 10):${RESET}"
find . -mindepth 1 -maxdepth 1 -type d 2>/dev/null | \
    xargs -I{} bash -c 'count=$(find "{}" 2>/dev/null | wc -l); echo $count "{}"' | \
    sort -nr | head -10 | \
    awk -v RED="$RED" -v YELLOW="$YELLOW" -v GREEN="$GREEN" -v RESET="$RESET" '
        {
        count=$1; dir=$2;
        color=GREEN;
        if(count>=50000) color=RED;
        else if(count>=10000) color=YELLOW;
        printf " %s%6d%s %s\n", color, count, RESET, dir;
    }'

# --- ./DOMEENID KAUST ---
if [ -d "./domeenid" ]; then
    # --- DOMEENIDE JAOTUS ---
    main_domains=$(find ./domeenid -mindepth 1 -maxdepth 1 -type d 2>/dev/null)
    for domain in $main_domains; do
        echo -e "\n${BOLD}$(basename "$domain") kausta jaotus (top 10):${RESET}"
        find "$domain" -mindepth 1 -maxdepth 1 -type d 2>/dev/null | \
            xargs -I{} bash -c 'count=$(find "{}" 2>/dev/null | wc -l); echo $count "{}"' | \
            sort -nr | head -10 | \
            awk -v RED="$RED" -v YELLOW="$YELLOW" -v GREEN="$GREEN" -v RESET="$RESET" '
            {
                count=$1; dir=$2;
                color=GREEN;
                if(count>=50000) color=RED;
                else if(count>=10000) color=YELLOW;
                printf " %s%6d%s %s\n", color, count, RESET, dir;
            }'
    done

    # --- ./DOMEENID KAUSTA JAOTUS
    echo -e "\n${BOLD}./domeenid kausta jaotus inode’de järgi (top 10):${RESET}"
    for d in ./domeenid/*; do
        [ -d "$d" ] || continue
        count=$(find "$d" -xdev -printf '.' 2>/dev/null | wc -c)
        echo "$count $d"
    done | sort -rn | head -n 10 | awk -v RED="$RED" -v YELLOW="$YELLOW" -v GREEN="$GREEN" -v RESET="$RESET" '
        {
            count=$1
            name=$2
            color=GREEN
            if(count>=50000) color=RED
            else if(count>=10000) color=YELLOW
            printf "%s%7d%s %s\n", color, count, RESET, name
        }'
fi

echo
