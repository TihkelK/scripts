#!/bin/bash

# ==== CONFIG ==== #
SINK_A="alsa_output.pci-0000_00_1f.3.hdmi-surround"   # Main speaker
SINK_B="alsa_output.usb-GeneralPlus_USB_Audio_Device-00.analog-stereo" # AUX-USB
DELAY_B=100   # Delay in ms for sink B (change this)

# convert ms -> microseconds
DELAY_US=$(($DELAY_B * 1000))

echo "ðŸ” Waiting for PulseAudio sinks..."
while ! pactl list short sinks | grep -q "$SINK_A"; do sleep 1; done
while ! pactl list short sinks | grep -q "$SINK_B"; do sleep 1; done
echo "ðŸŽ§ Sinks found."

# Kill previous attempts
pactl unload-module module-null-sink 2>/dev/null
pactl unload-module module-loopback 2>/dev/null
pactl unload-module module-ladspa-sink 2>/dev/null
pactl unload-module module-combine-sink 2>/dev/null

# Create null master
COMBINED=$(pactl load-module module-null-sink sink_name=COMB sink_properties=device.description="Combined_Output")

# Loop both devices to the master
LOOP_A=$(pactl load-module module-loopback source=COMB.monitor sink="$SINK_A" latency_msec=0)
LOOP_B=$(pactl load-module module-loopback source=COMB.monitor sink="$SINK_B" latency_msec=$DELAY_B)

# Make it the default output
pactl set-default-sink COMB

echo
echo "=========================================================="
echo " ðŸ”Š Output unified using NULL master sink"
echo " ðŸ•’ Delay applied to $SINK_B â†’ ${DELAY_B}ms"
echo " ðŸŽ¶ Play music â€” now adjust delay live via:"
echo
echo "     pactl unload-module $LOOP_B"
echo "     pactl load-module module-loopback source=COMB.monitor sink=\"$SINK_B\" latency_msec=XXXX"
echo "=========================================================="
